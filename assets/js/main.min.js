document.addEventListener("DOMContentLoaded", function () {
  const e = document.querySelectorAll(".nav-link");
  e.forEach((e) => {
    e.addEventListener("click", function (e) {
      const t = this.getAttribute("href");
      if (t.startsWith("#")) {
        e.preventDefault();
        const n = t.substring(1),
          a = document.getElementById(n);
        if (a) {
          a.scrollIntoView({ behavior: "smooth", block: "start" });
          const e = document.querySelector(".navbar-collapse");
          if (e.classList.contains("show")) {
            new bootstrap.Collapse(e).hide();
          }
        }
      }
    });
  });
  const t = document.querySelectorAll("section[id]");
  function n() {
    const e = window.pageYOffset;
    t.forEach((t) => {
      const n = t.offsetHeight,
        a = t.offsetTop - 100,
        o = t.getAttribute("id"),
        l = document.querySelector(`.nav-link[href="#${o}"]`);
      l && e > a && e <= a + n
        ? l.classList.add("active")
        : l && l.classList.remove("active");
    });
  }
  window.addEventListener("scroll", n);
  if (typeof GLightbox !== "undefined") {
    GLightbox({
      selector: ".glightbox",
      touchNavigation: !0,
      loop: !0,
      autoplayVideos: !1,
    });
  }
  const a = document.querySelectorAll(".gallery-filters .btn"),
    o = document.querySelectorAll(".gallery-item");
  a.forEach((e) => {
    e.addEventListener("click", function () {
      a.forEach((e) => e.classList.remove("active"));
      this.classList.add("active");
      const t = this.getAttribute("data-filter");
      o.forEach((e) => {
        const n = e.getAttribute("data-type");
        if (t === "all") {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "block";
            setTimeout(() => {
              e.style.opacity = "1";
            }, 10);
          }, 150);
        } else if (n === t) {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "block";
            setTimeout(() => {
              e.style.opacity = "1";
            }, 10);
          }, 150);
        } else {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "none";
          }, 300);
        }
      });
    });
  });
  const l = document.querySelectorAll(".step-details");
  l.forEach((e) => {
    e.addEventListener("show.bs.collapse", function () {
      const e = this.previousElementSibling,
        t = e.querySelector(".collapse-toggle i");
      t && (t.style.transform = "rotate(0deg)");
    });
    e.addEventListener("hide.bs.collapse", function () {
      const e = this.previousElementSibling,
        t = e.querySelector(".collapse-toggle i");
      t && (t.style.transform = "rotate(180deg)");
    });
  });
  const s = document.getElementById("navbar");
  function c() {
    window.scrollY > 50
      ? s.classList.add("scrolled")
      : s.classList.remove("scrolled");
  }
  window.addEventListener("scroll", c);
  c();
});


// Gallery Audio Control - Play "Song of Cathay" when scrolling into gallery section
(function() {
  const galleryAudio = document.getElementById('gallery-audio');
  const gallerySection = document.getElementById('gallery');
  const audioBanner = document.getElementById('audio-control-banner');
  const playBtn = document.getElementById('audio-play-btn');
  
  if (!galleryAudio || !gallerySection) return;
  
  let isPlaying = false;
  let userInteracted = false;
  let autoplayBlocked = false;
  let isInGalleryView = false;
  
  // Function to update button state
  function updateButtonState() {
    if (!playBtn) return;
    if (isPlaying) {
      playBtn.innerHTML = '<i class="bi bi-pause-fill me-1"></i> Pause Music';
      playBtn.classList.add('playing');
    } else {
      playBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i> Play Music';
      playBtn.classList.remove('playing');
    }
  }
  
  // Function to play audio
  function playAudio() {
    galleryAudio.play().then(() => {
      isPlaying = true;
      userInteracted = true;
      updateButtonState();
      console.log('Gallery audio started playing');
    }).catch(error => {
      console.log('Audio play prevented:', error);
      autoplayBlocked = true;
      if (audioBanner && isInGalleryView) {
        audioBanner.style.display = 'block';
      }
    });
  }
  
  // Function to pause audio
  function pauseAudio() {
    galleryAudio.pause();
    isPlaying = false;
    updateButtonState();
    console.log('Gallery audio paused');
  }
  
  // Manual play button click handler
  if (playBtn) {
    playBtn.addEventListener('click', () => {
      if (isPlaying) {
        pauseAudio();
      } else {
        playAudio();
      }
    });
  }
  
  // Try to enable audio on any user interaction
  const enableAudioOnInteraction = () => {
    if (!userInteracted && isInGalleryView) {
      playAudio();
    }
  };
  
  // Listen for user interactions
  ['click', 'touchstart', 'keydown'].forEach(event => {
    document.addEventListener(event, enableAudioOnInteraction, { once: true });
  });
  
  // Intersection Observer to detect when gallery section is in view
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        isInGalleryView = true;
        // Gallery section is in view, try to play audio
        if (!isPlaying) {
          playAudio();
        }
      } else {
        isInGalleryView = false;
        // Gallery section is out of view, pause audio
        if (isPlaying) {
          pauseAudio();
        }
        // Hide banner when leaving gallery
        if (audioBanner) {
          audioBanner.style.display = 'none';
        }
      }
    });
  }, {
    threshold: 0.3, // Trigger when 30% of the gallery is visible
    rootMargin: '0px'
  });
  
  // Start observing the gallery section
  observer.observe(gallerySection);
  
  // Handle page visibility change (pause when tab is hidden)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isPlaying) {
      pauseAudio();
    } else if (!document.hidden && isInGalleryView && userInteracted) {
      playAudio();
    }
  });
  
  // Try to play on page load if user has scrolled to gallery
  setTimeout(() => {
    const rect = gallerySection.getBoundingClientRect();
    if (rect.top < window.innerHeight && rect.bottom > 0) {
      isInGalleryView = true;
      playAudio();
    }
  }, 1000);
})();
