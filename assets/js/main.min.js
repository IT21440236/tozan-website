document.addEventListener("DOMContentLoaded", function () {
  const e = document.querySelectorAll(".nav-link");
  e.forEach((e) => {
    e.addEventListener("click", function (e) {
      const t = this.getAttribute("href");
      if (t.startsWith("#")) {
        e.preventDefault();
        const n = t.substring(1),
          a = document.getElementById(n);
        if (a) {
          a.scrollIntoView({ behavior: "smooth", block: "start" });
          const e = document.querySelector(".navbar-collapse");
          if (e.classList.contains("show")) {
            new bootstrap.Collapse(e).hide();
          }
        }
      }
    });
  });
  const t = document.querySelectorAll("section[id]");
  function n() {
    const e = window.pageYOffset;
    t.forEach((t) => {
      const n = t.offsetHeight,
        a = t.offsetTop - 100,
        o = t.getAttribute("id"),
        l = document.querySelector(`.nav-link[href="#${o}"]`);
      l && e > a && e <= a + n
        ? l.classList.add("active")
        : l && l.classList.remove("active");
    });
  }
  window.addEventListener("scroll", n);
  if (typeof GLightbox !== "undefined") {
    GLightbox({
      selector: ".glightbox",
      touchNavigation: !0,
      loop: !0,
      autoplayVideos: !1,
    });
  }
  const a = document.querySelectorAll(".gallery-filters .btn"),
    o = document.querySelectorAll(".gallery-item");
  a.forEach((e) => {
    e.addEventListener("click", function () {
      a.forEach((e) => e.classList.remove("active"));
      this.classList.add("active");
      const t = this.getAttribute("data-filter");
      o.forEach((e) => {
        const n = e.getAttribute("data-category") || e.getAttribute("data-type");
        if (t === "all") {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "block";
            setTimeout(() => {
              e.style.opacity = "1";
            }, 10);
          }, 150);
        } else if (n === t) {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "block";
            setTimeout(() => {
              e.style.opacity = "1";
            }, 10);
          }, 150);
        } else {
          e.style.opacity = "0";
          setTimeout(() => {
            e.style.display = "none";
          }, 300);
        }
      });
    });
  });
  const l = document.querySelectorAll(".step-details");
  l.forEach((e) => {
    e.addEventListener("show.bs.collapse", function () {
      const e = this.previousElementSibling,
        t = e.querySelector(".collapse-toggle i");
      t && (t.style.transform = "rotate(0deg)");
    });
    e.addEventListener("hide.bs.collapse", function () {
      const e = this.previousElementSibling,
        t = e.querySelector(".collapse-toggle i");
      t && (t.style.transform = "rotate(180deg)");
    });
  });
  const s = document.getElementById("navbar");
  function c() {
    window.scrollY > 50
      ? s.classList.add("scrolled")
      : s.classList.remove("scrolled");
  }
  window.addEventListener("scroll", c);
  c();
});


// Enhanced Gallery Audio Control - Play "Song of Cathay" when entering gallery section
(function() {
  const galleryAudio = document.getElementById('gallery-audio');
  const gallerySection = document.getElementById('gallery');
  const audioBanner = document.getElementById('audio-control-banner');
  const playBtn = document.getElementById('audio-play-btn');
  const galleryNavLink = document.querySelector('a[href="#gallery"]');
  
  if (!galleryAudio || !gallerySection) return;
  
  let isPlaying = false;
  let userInteracted = false;
  let autoplayBlocked = false;
  let isInGalleryView = false;
  let audioInitialized = false;
  
  // Function to update button state
  function updateButtonState() {
    if (!playBtn) return;
    if (isPlaying) {
      playBtn.innerHTML = '<i class="bi bi-pause-fill me-1"></i> Pause Music';
      playBtn.classList.add('playing');
    } else {
      playBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i> Play Music';
      playBtn.classList.remove('playing');
    }
  }
  
  // Function to play audio
  function playAudio() {
    if (!audioInitialized) {
      galleryAudio.volume = 0.7; // Set volume
      galleryAudio.loop = true; // Loop the audio
      audioInitialized = true;
    }
    
    galleryAudio.play().then(() => {
      isPlaying = true;
      userInteracted = true;
      updateButtonState();
      console.log('Gallery audio started playing');
      
      // Hide banner if audio plays successfully
      if (audioBanner) {
        audioBanner.style.display = 'none';
      }
    }).catch(error => {
      console.log('Audio play prevented:', error);
      autoplayBlocked = true;
      if (audioBanner && isInGalleryView) {
        audioBanner.style.display = 'block';
      }
    });
  }
  
  // Function to pause audio
  function pauseAudio() {
    galleryAudio.pause();
    isPlaying = false;
    updateButtonState();
    console.log('Gallery audio paused');
  }
  
  // Manual play button click handler
  if (playBtn) {
    playBtn.addEventListener('click', () => {
      if (isPlaying) {
        pauseAudio();
      } else {
        playAudio();
      }
    });
  }
  
  // Enhanced user interaction detection
  function enableAudioOnInteraction() {
    if (!userInteracted && isInGalleryView && !isPlaying) {
      playAudio();
    }
  }
  
  // Listen for various user interactions
  ['click', 'touchstart', 'keydown', 'scroll'].forEach(event => {
    document.addEventListener(event, enableAudioOnInteraction, { once: true });
  });
  
  // Handle Gallery navigation link clicks
  if (galleryNavLink) {
    galleryNavLink.addEventListener('click', () => {
      // Small delay to ensure section is in view
      setTimeout(() => {
        isInGalleryView = true;
        if (!isPlaying) {
          playAudio();
        }
      }, 500);
    });
  }
  
  // Enhanced Intersection Observer for better detection
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const wasInView = isInGalleryView;
      isInGalleryView = entry.isIntersecting;
      
      console.log('Gallery intersection:', entry.isIntersecting, 'Was in view:', wasInView, 'Is playing:', isPlaying);
      
      if (entry.isIntersecting && !wasInView) {
        // Just entered gallery section
        console.log('ðŸŽµ Entered gallery section - starting audio');
        if (!isPlaying) {
          playAudio();
        }
      } else if (!entry.isIntersecting && wasInView) {
        // Just left gallery section
        console.log('ðŸ”‡ Left gallery section - stopping audio');
        if (isPlaying) {
          pauseAudio();
        }
        // Hide banner when leaving gallery
        if (audioBanner) {
          audioBanner.style.display = 'none';
        }
      }
    });
  }, {
    threshold: 0.1, // Trigger when 10% of the gallery is visible
    rootMargin: '0px 0px 0px 0px' // No margin for precise detection
  });
  
  // Start observing the gallery section
  observer.observe(gallerySection);
  
  // Additional scroll-based detection as fallback
  let scrollTimeout;
  function checkGalleryVisibility() {
    if (!gallerySection) return;
    
    const rect = gallerySection.getBoundingClientRect();
    const windowHeight = window.innerHeight;
    const wasInView = isInGalleryView;
    
    // Check if any part of gallery is visible
    const isVisible = rect.top < windowHeight && rect.bottom > 0;
    
    if (isVisible !== wasInView) {
      isInGalleryView = isVisible;
      
      if (isVisible && !wasInView) {
        console.log('ðŸ“œ Scroll detected: Entered gallery - starting audio');
        if (!isPlaying) {
          playAudio();
        }
      } else if (!isVisible && wasInView) {
        console.log('ðŸ“œ Scroll detected: Left gallery - stopping audio');
        if (isPlaying) {
          pauseAudio();
        }
        if (audioBanner) {
          audioBanner.style.display = 'none';
        }
      }
    }
  }
  
  // Throttled scroll listener
  window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(checkGalleryVisibility, 100);
  });
  
  // Handle page visibility change (pause when tab is hidden)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isPlaying) {
      pauseAudio();
    } else if (!document.hidden && isInGalleryView && userInteracted) {
      playAudio();
    }
  });
  
  // Check if already in gallery on page load
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const rect = gallerySection.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      
      // Check if gallery section is currently visible
      if (rect.top < windowHeight && rect.bottom > 0) {
        isInGalleryView = true;
        console.log('Gallery section visible on page load');
        // Don't auto-play on page load, wait for user interaction
        if (audioBanner) {
          audioBanner.style.display = 'block';
        }
      }
    }, 1000);
  });
  
  // Handle hash navigation (direct links to #gallery)
  window.addEventListener('hashchange', () => {
    if (window.location.hash === '#gallery') {
      setTimeout(() => {
        isInGalleryView = true;
        if (!isPlaying) {
          playAudio();
        }
      }, 300);
    }
  });
  
  // Check hash on page load
  if (window.location.hash === '#gallery') {
    setTimeout(() => {
      isInGalleryView = true;
      if (audioBanner) {
        audioBanner.style.display = 'block';
      }
    }, 1000);
  }
})();

// Enhanced Pilgrimage Details - Sleek Sidebar Functionality
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('details-sidebar');
  const detailsSection = document.getElementById('details');
  const detailsContent = document.querySelector('.details-content');
  const sidebarProgressBar = document.getElementById('sidebar-progress');
  
  // Create sidebar toggle button
  const sidebarToggle = document.createElement('button');
  sidebarToggle.className = 'sidebar-toggle';
  sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
  sidebarToggle.title = 'Open Navigation';
  document.body.appendChild(sidebarToggle);
  
  // Create overlay for mobile
  const overlay = document.createElement('div');
  overlay.className = 'sidebar-overlay';
  document.body.appendChild(overlay);
  
  // Toggle sidebar
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (window.innerWidth > 1024) {
      detailsContent.classList.toggle('sidebar-open');
    }
    
    // Update toggle button icon
    const icon = sidebarToggle.querySelector('i');
    if (sidebar.classList.contains('active')) {
      icon.className = 'bi bi-x';
      sidebarToggle.title = 'Close Navigation';
    } else {
      icon.className = 'bi bi-list';
      sidebarToggle.title = 'Open Navigation';
    }
  }
  
  sidebarToggle.addEventListener('click', toggleSidebar);
  overlay.addEventListener('click', toggleSidebar);
  
  // Show/Hide sidebar toggle based on scroll position
  function toggleSidebarButton() {
    if (detailsSection) {
      const sectionTop = detailsSection.offsetTop;
      const sectionBottom = sectionTop + detailsSection.offsetHeight;
      const scrollTop = window.pageYOffset;
      const windowHeight = window.innerHeight;
      
      // Check if user is in the details section
      if (scrollTop + windowHeight > sectionTop && scrollTop < sectionBottom) {
        sidebarToggle.classList.add('visible');
        sidebar.classList.add('show');
      } else {
        sidebarToggle.classList.remove('visible');
        sidebar.classList.remove('show');
        // Auto-close sidebar when scrolling away
        if (sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    }
  }
  
  window.addEventListener('scroll', toggleSidebarButton);
  
  // Sidebar Progress Bar
  function updateSidebarProgress() {
    if (detailsSection && sidebarProgressBar) {
      const sectionTop = detailsSection.offsetTop;
      const sectionHeight = detailsSection.offsetHeight;
      const scrollTop = window.pageYOffset;
      const windowHeight = window.innerHeight;
      
      const sectionStart = sectionTop - windowHeight;
      const sectionEnd = sectionTop + sectionHeight;
      
      if (scrollTop >= sectionStart && scrollTop <= sectionEnd) {
        const progress = ((scrollTop - sectionStart) / (sectionEnd - sectionStart)) * 100;
        sidebarProgressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
      }
    }
  }
  
  window.addEventListener('scroll', updateSidebarProgress);
  
  // Active Sidebar Link Highlighting
  const sidebarLinks = document.querySelectorAll('.sidebar-link');
  const sections = document.querySelectorAll('.detail-section');
  
  function updateActiveSidebarLink() {
    let currentSection = '';
    
    sections.forEach(section => {
      const sectionTop = section.offsetTop - 200;
      if (window.pageYOffset >= sectionTop) {
        currentSection = section.getAttribute('id');
      }
    });
    
    sidebarLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('data-section') === currentSection) {
        link.classList.add('active');
      }
    });
  }
  
  window.addEventListener('scroll', updateActiveSidebarLink);
  
  // Smooth Scrolling for Sidebar Links
  sidebarLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('data-section');
      const targetSection = document.getElementById(targetId);
      
      if (targetSection) {
        targetSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // Auto-close sidebar on mobile after clicking
        if (window.innerWidth <= 1024) {
          setTimeout(() => {
            toggleSidebar();
          }, 300);
        }
      }
    });
  });
  
  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth > 1024) {
      overlay.classList.remove('active');
    } else {
      detailsContent.classList.remove('sidebar-open');
    }
  });
  
  // Enhanced Section Highlighting on Direct Link Access
  function highlightSectionFromHash() {
    const hash = window.location.hash;
    if (hash) {
      const targetSection = document.querySelector(hash);
      if (targetSection && targetSection.classList.contains('detail-section')) {
        setTimeout(() => {
          targetSection.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }, 100);
      }
    }
  }
  
  // Handle hash changes
  window.addEventListener('hashchange', highlightSectionFromHash);
  highlightSectionFromHash(); // Check on page load
});